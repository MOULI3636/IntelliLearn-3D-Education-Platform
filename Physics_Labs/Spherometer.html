<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spherometer Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            background-color: white;
        }
        .container {
            border: 2px solid #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #10b981;
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-thumb::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #10b981;
            cursor: pointer;
            border-radius: 50%;
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner {
            -moz-box-appearance: textfield;
        }
        .info-box {
            transition: all 0.3s ease-in-out;
        }
        .surface-transition {
            transition: d 0.5s ease-in-out;
        }
        .screw-transition {
            transition: transform 0.2s ease-in-out;
        }
        .contact-pulse {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 0.9; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        .tick-animation {
            transition: transform 0.1s linear;
        }
        .reading-highlight {
            background-color: #d1fae5;
            transition: background-color 0.3s ease;
        }
        .glow-border {
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            border: 1px solid #10b981;
        }
        .theory-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        .theory-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover {
            color: black;
        }
        #three-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }
        .btn-active {
            background-color: #059669 !important;
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-white text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- Three.js Background Container -->
    <div id="three-container"></div>

    <div class="container mx-auto max-w-7xl bg-white rounded-2xl p-6 md:p-8 relative">
        
        <!-- Header with Back Button -->
        <header class="text-center mb-8 border-b pb-4 relative">
            <!-- <button id="back-btn" class="absolute top-0 right-0 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm font-medium">
                Back to Main
            </button> -->
            <h1 class="text-3xl md:text-4xl font-bold text-green-700">Spherometer Simulator</h1>
            <p class="text-slate-500 mt-2">An interactive tool to learn how to measure the radius of curvature of spherical surfaces.</p>
            <button id="theory-btn" class="mt-4 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm font-medium">
                View Theory
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Left Column: Simulator & Visualization -->
            <div class="bg-slate-50 rounded-xl p-6 glow-border">
                <h2 class="text-xl font-semibold mb-4 text-center">Interactive Simulation</h2>

                <!-- Visualization -->
                <div class="relative w-full aspect-video bg-gradient-to-b from-green-50 to-slate-100 rounded-lg shadow-md mb-6 flex items-center justify-center p-4 overflow-hidden border border-green-300">
                    <svg id="visualization" class="w-full h-full" viewBox="0 0 400 250">
                        <!-- Surface -->
                        <defs>
                            <linearGradient id="surfaceGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#10b981" />
                                <stop offset="100%" stop-color="#059669" />
                            </linearGradient>
                            <linearGradient id="screwGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#94a3b8" />
                                <stop offset="50%" stop-color="#64748b" />
                                <stop offset="100%" stop-color="#475569" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Surface -->
                        <path id="surface" class="surface-transition" d="M 0 180 H 400" stroke="url(#surfaceGradient)" stroke-width="4" fill="none" stroke-linecap="round"/>
                        
                        <!-- Legs -->
                        <g id="legs">
                            <line x1="100" y1="180" x2="100" y2="200" stroke="#475569" stroke-width="4" stroke-linecap="round" />
                            <line x1="300" y1="180" x2="300" y2="200" stroke="#475569" stroke-width="4" stroke-linecap="round" />
                            <line x1="200" y1="180" x2="200" y2="200" stroke="#475569" stroke-width="4" stroke-linecap="round" />
                            <circle cx="100" cy="200" r="5" fill="#475569" />
                            <circle cx="300" cy="200" r="5" fill="#475569" />
                            <circle cx="200" cy="200" r="5" fill="#475569" />
                            <line x1="100" y1="200" x2="300" y2="200" stroke="#475569" stroke-width="1" stroke-dasharray="4" />
                            <line x1="200" y1="200" x2="300" y2="200" stroke="#475569" stroke-width="1" stroke-dasharray="4" />
                            <line x1="100" y1="200" x2="200" y2="200" stroke="#475569" stroke-width="1" stroke-dasharray="4" />
                        </g>

                        <!-- Central Screw -->
                        <g id="central-screw-group" class="screw-transition" transform="translate(0, 0)">
                            <!-- Screw body -->
                            <rect x="195" y="50" width="10" height="130" rx="2" fill="url(#screwGradient)" />
                            <!-- Screw tip -->
                            <polygon points="195,180 205,180 200,190" fill="#374151" />
                            <!-- Screw head -->
                            <rect x="185" y="40" width="30" height="10" rx="2" fill="#1e293b" />
                            <rect x="190" y="30" width="20" height="10" rx="1" fill="#1e293b" />
                        </g>
                        
                        <!-- Contact Feedback -->
                        <circle id="contact-indicator" cx="200" cy="180" r="8" fill="rgba(239, 68, 68, 0.7)" opacity="0" />
                        
                        <!-- Measurement line -->
                        <line id="measurement-line" x1="200" y1="180" x2="200" y2="200" stroke="#dc2626" stroke-width="2" stroke-dasharray="4" opacity="0" />
                        
                        <!-- Sagitta label -->
                        <text id="sagitta-label" x="210" y="190" font-size="12" fill="#dc2626" opacity="0">h</text>
                    </svg>
                    
                    <!-- Overlay instructions -->
                    <div id="contact-message" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-3 py-1 rounded-md text-sm font-medium opacity-0 transition-opacity duration-300">
                        Contact Made!
                    </div>
                </div>

                <!-- Controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow glow-border">
                        <label class="block text-sm font-medium text-slate-700 mb-2">1. Select Surface</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="surfaceType" value="plane" class="form-radio text-green-600" checked>
                                <span class="ml-2">Plane Surface</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="surfaceType" value="spherical" class="form-radio text-green-600">
                                <span class="ml-2">Spherical Surface</span>
                            </label>
                        </div>
                    </div>
                    <div id="radius-control-container" class="bg-white p-4 rounded-lg shadow glow-border hidden">
                        <label for="radius-slider" class="block text-sm font-medium text-slate-700 mb-1">Set Radius of Curvature: <span id="radius-value" class="font-bold text-green-600">15.0</span> cm</label>
                        <input id="radius-slider" type="range" min="10" max="50" step="0.1" value="15" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>10 cm</span>
                            <span>50 cm</span>
                        </div>
                    </div>
                </div>
                 
                 <div class="mt-4 bg-white p-4 rounded-lg shadow glow-border">
                    <label for="screw-control" class="block text-sm font-medium text-slate-700 mb-2">2. Adjust Central Screw</label>
                    <input id="screw-control" type="range" min="0" max="10" value="5" step="0.005" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>0 mm</span>
                        <span>10 mm</span>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">
                        <span class="font-medium">Tip:</span> Slowly adjust until the contact indicator appears
                    </div>
                </div>
                <!-- Instructions Panel - Add this at the bottom of the left column -->
                <div class="mt-6 bg-green-50 border border-green-200 rounded-xl p-4 glow-border">
                    <h3 class="text-lg font-semibold mb-3 text-green-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        How to Calculate
                    </h3>
                    <div class="text-sm text-slate-600 space-y-2">
                        <div class="flex items-start">
                            <span class="bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0">1</span>
                            <span>Set <strong class="text-green-700">Plane Reading (R‚ÇÅ)</strong> when contact is made on flat surface</span>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0">2</span>
                            <span>Set <strong class="text-green-700">Sphere Reading (R‚ÇÇ)</strong> when contact is made on curved surface</span>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0">3</span>
                            <span>Formula: <code class="bg-green-100 px-1 rounded text-green-800 font-mono">R = (l¬≤/6h) + (h/2)</code></span>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0">4</span>
                            <span>Where: <strong class="text-green-700">h = R‚ÇÇ - R‚ÇÅ</strong> (sagitta)</span>
                        </div>
                        <div class="mt-3 p-2 bg-white rounded border border-green-200">
                            <p class="text-xs font-medium text-green-600">üí° Tip: Look for the red contact indicator before setting readings!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Readings & Calculation -->
            <div class="flex flex-col space-y-6">
                
                <!-- Readings Panel -->
                <div class="bg-slate-50 rounded-xl p-6 shadow-inner glow-border">
                    <h2 class="text-xl font-semibold mb-4 text-center">Instrument Readings</h2>

                    <!-- Magnified Scale View -->
                    <div class="w-full max-w-xs mx-auto bg-white rounded-lg shadow-md p-2 mb-4 ring-1 ring-slate-200 border border-green-300">
                        <div class="text-center text-xs text-slate-500 mb-1">Magnified Scale View</div>
                        <svg id="scale-view" class="w-full" height="200" viewBox="0 0 100 200">
                            <!-- Datum Line -->
                            <line x1="25" y1="100" x2="75" y2="100" stroke="red" stroke-width="1.5" stroke-linecap="round"/>
                            <polygon points="22,96 25,100 22,104" fill="red" />
                            
                            <!-- Main Scale Group -->
                            <g id="main-scale-group" class="tick-animation"></g>
                            
                            <!-- Circular Scale Group -->
                            <g id="circular-scale-group" class="tick-animation"></g>
                            
                            <!-- Reading line -->
                            <line id="reading-line" x1="30" y1="100" x2="70" y2="100" stroke="#10b981" stroke-width="2" opacity="0" />
                        </svg>
                    </div>

                    <div class="flex justify-center items-center space-x-4">
                        <!-- Main Scale -->
                        <div class="text-center p-4 bg-white rounded-lg shadow w-40 glow-border">
                            <div class="text-sm text-slate-500">Main Scale (MSR)</div>
                            <div id="msr-display" class="text-3xl font-bold text-green-700">5.00 mm</div>
                        </div>
                        <!-- Circular Scale -->
                        <div class="text-center p-4 bg-white rounded-lg shadow w-40 glow-border">
                             <div class="text-sm text-slate-500">Circular Scale (CSD)</div>
                             <div id="csr-display" class="text-3xl font-bold text-green-700">0</div>
                        </div>
                    </div>
                     
                     <div class="mt-4 text-center text-sm text-slate-500 bg-green-50 p-2 rounded-lg border border-green-100">
                        <p class="font-medium">Total Reading = MSR + (CSD √ó L.C.)</p>
                        <p id="total-reading-display" class="text-lg font-bold text-green-700 mt-1">5.000 mm</p>
                    </div>
                </div>

                <!-- Calculation Panel -->
                 <div class="bg-green-50 border border-green-200 rounded-xl p-6 shadow-inner glow-border">
                    <h2 class="text-xl font-semibold mb-4 text-center">Calculation</h2>
                    
                    <!-- Instrument Constants -->
                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div class="bg-white p-3 rounded-lg text-center glow-border">
                            <span class="font-medium">Pitch:</span> 1 mm
                        </div>
                        <div class="bg-white p-3 rounded-lg text-center glow-border">
                            <span class="font-medium">Least Count (L.C.):</span> 0.01 mm
                        </div>
                         <div class="bg-white p-3 rounded-lg text-center col-span-2 glow-border">
                            <span class="font-medium">Distance between legs (l):</span> 4.0 cm
                        </div>
                    </div>
                    
                    <!-- User Input -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Reading on Plane ($R_1$)</label>
                            <div class="flex items-center mt-1">
                                <input type="number" id="plane-reading" class="w-full p-2 border border-green-300 rounded-md shadow-sm no-spinner bg-white" placeholder="mm" step="0.001" value="0.000" readonly>
                                <button id="set-plane-reading" class="ml-2 px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm font-medium">Set</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Reading on Sphere ($R_2$)</label>
                            <div class="flex items-center mt-1">
                                <input type="number" id="sphere-reading" class="w-full p-2 border border-green-300 rounded-md shadow-sm no-spinner bg-white" placeholder="mm" step="0.001" value="0.000" readonly>
                                <button id="set-sphere-reading" class="ml-2 px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm font-medium">Set</button>
                            </div>
                        </div>
                    </div>

                    <button id="calculate-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors shadow-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                        </svg>
                        Calculate Radius of Curvature
                    </button>
                    
                    <!-- Results -->
                    <div id="result-container" class="mt-4 text-center hidden">
                        <div class="bg-white p-4 rounded-lg glow-border">
                            <p class="text-sm text-slate-600">Calculated Sagitta, $h = R_2 - R_1 = <span id="h-value" class="font-bold text-green-700"></span>$ mm</p>
                            <p class="text-lg mt-2 font-medium">Radius of Curvature (R) is:</p>
                            <p class="text-3xl font-bold text-green-600 mt-1"><span id="result-value"></span> cm</p>
                            <div class="mt-2 text-sm text-slate-500">
                                <p>Actual Radius: <span id="actual-radius-display" class="font-medium"></span> cm</p>
                                <p id="accuracy-display" class="mt-1 font-medium"></p>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Theory Modal -->
    <div id="theory-modal" class="theory-modal">
        <div class="theory-content">
            <span class="close-btn">&times;</span>
            <h2 class="text-2xl font-bold text-green-700 mb-4">Spherometer Theory</h2>
            <div class="text-slate-600 space-y-4">
                <p>A spherometer is an instrument used to measure the radius of curvature of spherical surfaces. It consists of a central screw and three outer legs that form an equilateral triangle.</p>
                
                <h3 class="text-xl font-semibold mt-4">Principle</h3>
                <p>The spherometer works on the principle of measuring the sagitta (h) - the vertical distance between the plane of the three outer legs and the point where the central screw touches the surface.</p>
                
                <h3 class="text-xl font-semibold mt-4">Formula</h3>
                <p>The radius of curvature (R) is calculated using the formula:</p>
                <div class="bg-slate-100 p-3 rounded-md my-2 text-center">
                    <code class="text-lg font-mono">R = (l¬≤ / 6h) + (h / 2)</code>
                </div>
                <p>Where:</p>
                <ul class="list-disc list-inside ml-4">
                    <li>R = Radius of curvature</li>
                    <li>l = Distance between any two legs of the spherometer</li>
                    <li>h = Sagitta (difference in readings between plane and spherical surfaces)</li>
                </ul>
                
                <h3 class="text-xl font-semibold mt-4">Procedure</h3>
                <ol class="list-decimal list-inside space-y-2 ml-4">
                    <li><strong>Find the Zero Reading:</strong> Place the spherometer on a plane surface and adjust the central screw until it just touches the surface. Record this reading as R‚ÇÅ.</li>
                    <li><strong>Place on Spherical Surface:</strong> Place the spherometer on the spherical surface whose radius of curvature is to be measured.</li>
                    <li><strong>Take Reading on Sphere:</strong> Adjust the central screw until it just touches the spherical surface. Record this reading as R‚ÇÇ.</li>
                    <li><strong>Calculate Sagitta:</strong> Calculate h = R‚ÇÇ - R‚ÇÅ</li>
                    <li><strong>Calculate Radius:</strong> Use the formula to calculate the radius of curvature R.</li>
                </ol>
                
                <h3 class="text-xl font-semibold mt-4">Least Count</h3>
                <p>The least count of a spherometer is given by:</p>
                <div class="bg-slate-100 p-3 rounded-md my-2 text-center">
                    <code class="text-lg font-mono">Least Count = Pitch / Number of divisions on circular scale</code>
                </div>
                <p>For a typical spherometer with pitch = 1 mm and 100 divisions on the circular scale, the least count is 0.01 mm.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const visualization = document.getElementById('visualization');
            const surfacePath = document.getElementById('surface');
            const screwGroup = document.getElementById('central-screw-group');
            const contactIndicator = document.getElementById('contact-indicator');
            const contactMessage = document.getElementById('contact-message');
            const measurementLine = document.getElementById('measurement-line');
            const sagittaLabel = document.getElementById('sagitta-label');
            const readingLine = document.getElementById('reading-line');

            const surfaceTypeRadios = document.querySelectorAll('input[name="surfaceType"]');
            const radiusControlContainer = document.getElementById('radius-control-container');
            const radiusSlider = document.getElementById('radius-slider');
            const radiusValueDisplay = document.getElementById('radius-value');
            const screwControl = document.getElementById('screw-control');

            const msrDisplay = document.getElementById('msr-display');
            const csrDisplay = document.getElementById('csr-display');
            const totalReadingDisplay = document.getElementById('total-reading-display');

            const planeReadingInput = document.getElementById('plane-reading');
            const sphereReadingInput = document.getElementById('sphere-reading');
            const setPlaneReadingBtn = document.getElementById('set-plane-reading');
            const setSphereReadingBtn = document.getElementById('set-sphere-reading');
            const calculateBtn = document.getElementById('calculate-btn');

            const resultContainer = document.getElementById('result-container');
            const hValueDisplay = document.getElementById('h-value');
            const resultValueDisplay = document.getElementById('result-value');
            const actualRadiusDisplay = document.getElementById('actual-radius-display');
            const accuracyDisplay = document.getElementById('accuracy-display');

            // Theory modal elements
            const theoryModal = document.getElementById('theory-modal');
            const theoryBtn = document.getElementById('theory-btn');
            const closeBtn = document.querySelector('.close-btn');
            const backBtn = document.getElementById('back-btn');

            // --- Constants and State ---
            const PITCH = 1; // mm
            const NUM_DIVISIONS = 100;
            const LEAST_COUNT = PITCH / NUM_DIVISIONS; // 0.01 mm
            const LEG_DISTANCE_L = 40; // mm (4.0 cm)
            const LEG_SEPARATION_R = LEG_DISTANCE_L / Math.sqrt(3); // distance from center to a leg

            let state = {
                surface: 'plane', // 'plane' or 'spherical'
                radiusCm: 15, // in cm
                screwPositionMm: 5, // current position in mm from an arbitrary zero
                contactPositionMm: 0,
                planeReading: null,
                sphereReading: null,
                isContactMade: false
            };

            // --- Three.js Background ---
            function initThreeBackground() {
                const container = document.getElementById('three-container');
                const width = container.clientWidth;
                const height = container.clientHeight;

                // Create scene
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0fdf4); // Very light green background

                // Create camera
                const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                camera.position.z = 5;

                // Create renderer
                const renderer = new THREE.WebGLRenderer({ alpha: true });
                renderer.setSize(width, height);
                container.appendChild(renderer.domElement);

                // Create particles
                const particlesGeometry = new THREE.BufferGeometry();
                const particlesCount = 100;
                const posArray = new Float32Array(particlesCount * 3);

                for (let i = 0; i < particlesCount * 3; i++) {
                    posArray[i] = (Math.random() - 0.5) * 10;
                }

                particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));

                // Create material
                const particlesMaterial = new THREE.PointsMaterial({
                    size: 0.05,
                    color: 0x10b981, // Green color
                    transparent: true,
                    opacity: 0.5
                });

                // Create mesh
                const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
                scene.add(particlesMesh);

                // Animation
                function animate() {
                    requestAnimationFrame(animate);
                    particlesMesh.rotation.y += 0.001;
                    renderer.render(scene, camera);
                }

                animate();

                // Handle window resize
                window.addEventListener('resize', () => {
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    renderer.setSize(width, height);
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                });
            }

            // --- Core Functions ---
            function calculateSagitta(radiusMm) {
                if (radiusMm < LEG_SEPARATION_R) return 0; // Cannot measure if radius is too small
                // R^2 = r^2 + (R-h)^2  => h = R - sqrt(R^2 - r^2)
                return radiusMm - Math.sqrt(radiusMm * radiusMm - LEG_SEPARATION_R * LEG_SEPARATION_R);
            }
            
            function updateContactPosition() {
                if (state.surface === 'plane') {
                    state.contactPositionMm = 0;
                } else {
                    const radiusMm = state.radiusCm * 10;
                    state.contactPositionMm = calculateSagitta(radiusMm);
                }
            }

            // --- Scale Drawing Function ---
            function setupScales() {
                const mainScaleGroup = document.getElementById('main-scale-group');
                const circularScaleGroup = document.getElementById('circular-scale-group');
                const svgNS = "http://www.w3.org/2000/svg";
                const PIXELS_PER_MM = 40;
                const DATUM_Y = 100;

                // Clear existing scales
                mainScaleGroup.innerHTML = '';
                circularScaleGroup.innerHTML = '';

                // --- Main Scale (Linear) ---
                const mainScaleLine = document.createElementNS(svgNS, 'line');
                mainScaleLine.setAttribute('x1', '40');
                mainScaleLine.setAttribute('y1', '-1000');
                mainScaleLine.setAttribute('x2', '40');
                mainScaleLine.setAttribute('y2', '1000');
                mainScaleLine.setAttribute('stroke', '#334155');
                mainScaleLine.setAttribute('stroke-width', '1');
                mainScaleGroup.appendChild(mainScaleLine);

                for (let i = -10; i <= 20; i++) {
                    const y = DATUM_Y - (i * PIXELS_PER_MM);
                    const majorTick = document.createElementNS(svgNS, 'line');
                    majorTick.setAttribute('x1', '40');
                    majorTick.setAttribute('y1', y);
                    majorTick.setAttribute('x2', '30');
                    majorTick.setAttribute('y2', y);
                    majorTick.setAttribute('stroke', '#334155');
                    majorTick.setAttribute('stroke-width', '1');
                    mainScaleGroup.appendChild(majorTick);
                    
                    const number = document.createElementNS(svgNS, 'text');
                    number.setAttribute('x', '25');
                    number.setAttribute('y', y + 3);
                    number.setAttribute('text-anchor', 'end');
                    number.setAttribute('font-size', '8');
                    number.setAttribute('fill', '#475569');
                    number.textContent = i;
                    mainScaleGroup.appendChild(number);

                    if (i < 20) {
                        const minorY = y - (PIXELS_PER_MM / 2);
                        const minorTick = document.createElementNS(svgNS, 'line');
                        minorTick.setAttribute('x1', '40');
                        minorTick.setAttribute('y1', minorY);
                        minorTick.setAttribute('x2', '35');
                        minorTick.setAttribute('y2', minorY);
                        minorTick.setAttribute('stroke', '#334155');
                        minorTick.setAttribute('stroke-width', '0.5');
                        mainScaleGroup.appendChild(minorTick);
                    }
                }

                // --- Circular Scale ---
                const PIXELS_PER_DIVISION = (PIXELS_PER_MM * PITCH) / NUM_DIVISIONS;
                for (let i = -100; i < 200; i++) {
                    const y = DATUM_Y - (i * PIXELS_PER_DIVISION);
                    const isMajor = i % 5 === 0;
                    const tickLength = isMajor ? 10 : 5;
                    
                    const tick = document.createElementNS(svgNS, 'line');
                    tick.setAttribute('x1', '60');
                    tick.setAttribute('y1', y);
                    tick.setAttribute('x2', 60 + tickLength);
                    tick.setAttribute('y2', y);
                    tick.setAttribute('stroke', '#334155');
                    tick.setAttribute('stroke-width', isMajor ? '1' : '0.5');
                    circularScaleGroup.appendChild(tick);

                    if (isMajor) {
                        const number = document.createElementNS(svgNS, 'text');
                        number.setAttribute('x', '72');
                        number.setAttribute('y', y + 3);
                        number.setAttribute('font-size', '8');
                        number.setAttribute('fill', '#475569');
                        number.textContent = (i + NUM_DIVISIONS * 10) % NUM_DIVISIONS;
                        circularScaleGroup.appendChild(number);
                    }
                }
            }

            // --- Update and Render Functions ---
            function render() {
                // 1. Render Surface
                const viewBoxHeight = 250;
                const baselineY = 180;
                if (state.surface === 'plane') {
                    surfacePath.setAttribute('d', `M 0 ${baselineY} H 400`);
                } else {
                    const radiusMm = state.radiusCm * 10;
                    const h = calculateSagitta(radiusMm);
                    
                    // Scale h for visualization (exaggerate for small h)
                    const visualH = Math.max(h * 5, 1);
                    const visualRadius = (150*150 + visualH*visualH) / (2*visualH); // Calculate radius for SVG arc
                    
                    surfacePath.setAttribute('d', `M 50 ${baselineY} A ${visualRadius} ${visualRadius} 0 0 0 350 ${baselineY}`);
                }

                // 2. Render Screw Position
                const visualScrewPos = baselineY - (state.screwPositionMm * 5); // Scale for visibility
                screwGroup.setAttribute('transform', `translate(0, ${visualScrewPos - 130})`);
                
                // 3. Render Readings (Digital and Visual)
                const totalReading = state.screwPositionMm;
                const msr = Math.floor(totalReading);
                const csr = Math.round((totalReading - msr) / LEAST_COUNT) % NUM_DIVISIONS;
                
                msrDisplay.textContent = `${msr}.00 mm`;
                csrDisplay.textContent = csr;
                totalReadingDisplay.textContent = `${totalReading.toFixed(3)} mm`;

                // Visual Scales
                const mainScaleGroup = document.getElementById('main-scale-group');
                const circularScaleGroup = document.getElementById('circular-scale-group');
                const PIXELS_PER_MM = 40;
                const totalOffset = totalReading * PIXELS_PER_MM;
                
                mainScaleGroup.setAttribute('transform', `translate(0, ${totalOffset})`);
                circularScaleGroup.setAttribute('transform', `translate(0, ${totalOffset})`);
                
                // 4. Render Contact Indicator
                const distanceToContact = Math.abs(state.screwPositionMm - state.contactPositionMm);
                state.isContactMade = distanceToContact < LEAST_COUNT * 2;
                
                if (state.isContactMade) {
                    const indicatorY = baselineY - (state.contactPositionMm * 5);
                    contactIndicator.setAttribute('cy', indicatorY);
                    contactIndicator.style.opacity = '1';
                    contactIndicator.classList.add('contact-pulse');
                    contactMessage.style.opacity = '1';
                    
                    // Show measurement line and label for spherical surface
                    if (state.surface === 'spherical') {
                        measurementLine.setAttribute('y1', indicatorY);
                        measurementLine.setAttribute('y2', baselineY);
                        measurementLine.style.opacity = '1';
                        
                        sagittaLabel.setAttribute('y', (indicatorY + baselineY) / 2);
                        sagittaLabel.style.opacity = '1';
                    } else {
                        measurementLine.style.opacity = '0';
                        sagittaLabel.style.opacity = '0';
                    }
                } else {
                    contactIndicator.style.opacity = '0';
                    contactIndicator.classList.remove('contact-pulse');
                    contactMessage.style.opacity = '0';
                    measurementLine.style.opacity = '0';
                    sagittaLabel.style.opacity = '0';
                }
                
                // Update reading line in scale view
                readingLine.setAttribute('y1', 100 - totalOffset);
                readingLine.setAttribute('y2', 100 - totalOffset);
                readingLine.style.opacity = '1';
            }

            // --- Event Handlers ---
            surfaceTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    state.surface = e.target.value;
                    radiusControlContainer.classList.toggle('hidden', state.surface === 'plane');
                    resultContainer.classList.add('hidden');
                    sphereReadingInput.value = '0.000';
                    updateContactPosition();
                    render();
                });
            });

            radiusSlider.addEventListener('input', (e) => {
                state.radiusCm = parseFloat(e.target.value);
                radiusValueDisplay.textContent = `${state.radiusCm.toFixed(1)} cm`;
                updateContactPosition();
                render();
            });

            screwControl.addEventListener('input', (e) => {
                state.screwPositionMm = parseFloat(e.target.value);
                render();
            });

            // Set Plane Reading
            setPlaneReadingBtn.addEventListener('click', () => {
                if (state.surface === 'plane' && state.isContactMade) {
                    const reading = state.screwPositionMm.toFixed(3);
                    planeReadingInput.value = reading;
                    state.planeReading = parseFloat(reading);
                    
                    // Visual feedback
                    planeReadingInput.classList.add('reading-highlight');
                    setPlaneReadingBtn.classList.add('btn-active');
                    setTimeout(() => {
                        planeReadingInput.classList.remove('reading-highlight');
                        setPlaneReadingBtn.classList.remove('btn-active');
                    }, 500);
                    
                    console.log("Plane reading set to:", reading);
                } else {
                    alert('Please select "Plane Surface" and adjust the screw until contact is made (red indicator appears).');
                }
            });

            // Set Sphere Reading
            setSphereReadingBtn.addEventListener('click', () => {
                if (state.surface === 'spherical' && state.isContactMade) {
                    const reading = state.screwPositionMm.toFixed(3);
                    sphereReadingInput.value = reading;
                    state.sphereReading = parseFloat(reading);
                    
                    // Visual feedback
                    sphereReadingInput.classList.add('reading-highlight');
                    setSphereReadingBtn.classList.add('btn-active');
                    setTimeout(() => {
                        sphereReadingInput.classList.remove('reading-highlight');
                        setSphereReadingBtn.classList.remove('btn-active');
                    }, 500);
                    
                    console.log("Sphere reading set to:", reading);
                } else {
                    alert('Please select "Spherical Surface" and adjust the screw until contact is made (red indicator appears).');
                }
            });

            // Calculate Result
            calculateBtn.addEventListener('click', () => {
                console.log("Calculate clicked");
                console.log("Plane reading:", state.planeReading);
                console.log("Sphere reading:", state.sphereReading);
                
                if (state.planeReading === null || state.sphereReading === null) {
                    alert('Please set both plane and sphere readings first.');
                    return;
                }
                
                const h = Math.abs(state.sphereReading - state.planeReading);
                const hMm = h;
                const lMm = LEG_DISTANCE_L;
                
                // R = (l¬≤ / 6h) + (h / 2)
                const radiusMm = (lMm * lMm) / (6 * hMm) + (hMm / 2);
                const radiusCm = radiusMm / 10;
                
                hValueDisplay.textContent = h.toFixed(3);
                resultValueDisplay.textContent = radiusCm.toFixed(3);
                actualRadiusDisplay.textContent = state.radiusCm.toFixed(1);
                
                const error = Math.abs(radiusCm - state.radiusCm);
                const percentError = (error / state.radiusCm) * 100;
                
                if (percentError < 2) {
                    accuracyDisplay.textContent = `Excellent! Error: ${percentError.toFixed(1)}%`;
                    accuracyDisplay.className = 'text-green-600';
                } else if (percentError < 5) {
                    accuracyDisplay.textContent = `Good! Error: ${percentError.toFixed(1)}%`;
                    accuracyDisplay.className = 'text-yellow-600';
                } else {
                    accuracyDisplay.textContent = `Try again! Error: ${percentError.toFixed(1)}%`;
                    accuracyDisplay.className = 'text-red-600';
                }
                
                resultContainer.classList.remove('hidden');
            });

            // Theory Modal
            theoryBtn.addEventListener('click', () => {
                theoryModal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                theoryModal.style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                if (e.target === theoryModal) {
                    theoryModal.style.display = 'none';
                }
            });

            // Back button
            backBtn.addEventListener('click', () => {
                alert('Back button clicked. You can attach a link to go back to the main page.');
                // Example: window.location.href = 'main-page.html';
            });

            // --- Initialize ---
            function init() {
                setupScales();
                updateContactPosition();
                render();
                initThreeBackground();
                
                // Initialize readings
                planeReadingInput.value = '0.000';
                sphereReadingInput.value = '0.000';
            }

            init();
        });
    </script>
</body>
</html>